<!DOCTYPE html>
<html>

<head>
  <title>Using Paths</title>
</head>

<body>

  <svg id="svg" width="600" height="600"></svg>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    d3.csv('./data/Innocent Deaths caused by Police (All time).csv')
      .then(handleData)

    function handleData(data) {

      const yearlyDeaths = getYearlyCasualties(data)

      console.log(yearlyDeaths)

      const margin = 75
      const height = 600
      const width = 600


      const yearExtent = d3.extent(yearlyDeaths, d => d.year)
      const xscale = d3.scaleLinear()
        .domain(yearExtent)
        .range([height - margin, margin])

      const casualtyCount = d3.extent(yearlyDeaths, d => d.count)
      const yscale = d3.scaleLinear()
        .domain(casualtyCount)
        .range([height - margin, margin])

      // line generator
      const linegen = d3.line()
        .x(d => xscale(d.year)) // Use date here! 
        .y(d => yscale(d.count))
        .curve(d3.curveLinear)

      // Select the svg
      const svg = d3
        .select('#svg')

      // Make a group for the graph
      const graph = svg
        .append('g')

      // Draw the graph
      graph
        .append('path')
        .attr('d', linegen(yearlyDeaths))
        .attr('stroke-width', 1)
        .attr('stroke', 'cornflowerblue')
        .attr('fill', 'none')

      // Create the axis
      const bottomAxis = d3.axisBottom(xscale)
      const leftAxis = d3.axisLeft(yscale)

      // Append a group and add the bottom axis 
      svg
        .append('g')
        // Position the group
        .attr('transform', `translate(0, ${height - margin})`)
        // generate the axis in the group
        .call(bottomAxis)

      // Append the group and add the left axis
      svg
        .append('g')
        .attr('transform', `translate(${margin}, 0)`)
        .call(leftAxis)
    }

    function getYearlyCasualties(data) {
      // save the death date column name
      const dateOfDeath = " Date of injury resulting in death (month/day/year)"

      // create parse format
      const parseTime = d3.timeParse('%m/%d/%Y')
      // parse the dates for d3
      data.forEach(d => d[dateOfDeath] = parseTime(d[dateOfDeath]))

      // Find the extents of the years in the dates
      const yearExtent = d3.extent(data, d => d[dateOfDeath].getFullYear())

      const yearlyDeaths = []

      // get number of deaths for each year in the date extent
      for (let i = yearExtent[0]; i <= yearExtent[1]; i++) {
        const deathCount = data.reduce((accum, person) => {
          if (person[dateOfDeath].getFullYear() === i) {
            return accum + 1
          }
          return accum
        }, 0)

        yearlyDeaths.push({ year: i, count: deathCount })
      }

      return yearlyDeaths
    }
  </script>
</body>

<style>
  /* Put the box in the center of the page */
  body,
  html {
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  #svg {
    border: 1px solid;
  }
</style>

</html>